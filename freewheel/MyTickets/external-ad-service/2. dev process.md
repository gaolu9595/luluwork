# DEV PROCESS



[TOC]



## protobuf

1. brew install protobuf

2. go get -u github.com/golang/protobuf/protoc-gen-go

3. de_request.proto å®šä¹‰

4. de_request.proto ç¼–è¯‘: **protoc --go_out=[objective path] [source path]**

   1. â€œprotoc --go_out=...â€ï¼Œæ‰¾ä¸åˆ°protoreflectçš„google.golang.org/protobufçš„åŒ…
   2. `github.com/golang/protobuf`æ–‡æ¡£ï¼Œé‡Œè¾¹æåˆ°`v1.4.0`ç‰ˆæœ¬å, åè¾¹ä»£ç å°†äº¤ç”±`google.golang.org/protobuf` Repoç»´æŠ¤ï¼Œ**åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼šæ–°åŠ ä¸‰ä¸ªå­—æ®µï¼šstate/cacheSize/unknownFields**
   3. éœ€è¦å¯ç”¨vendorç®¡ç†è‡ªå·±serviceçš„ä¾èµ–åŒ…ï¼ŒåŠ å…¥`google.golang.org/protobuf`

5. serviceå†…éƒ¨çš„vendorä¾èµ–åŒ…ç®¡ç†ï¼š

   1. gopathä¸‹ï¼Œgo get -u github.com/kardianos/govendor
   2. serviceç›®å½•ä¸‹ï¼Œgovendor initï¼Œgovendor listï¼Œ govendor fetch +out

6. de_request.pb.go ç†è§£

7. ç»ƒä¹ åºåˆ—åŒ–å’Œååºåˆ—åŒ–protobufæ•°æ®ï¼Œè§£æå‡ºç›¸åº”æ ¼å¼çš„message

   1. marshalæ˜¯åºåˆ—åŒ–
   2. unmarshalæ˜¯ååºåˆ—åŒ–

   <img src="/Users/lugao/Library/Application Support/typora-user-images/image-20201028151324162.png" alt="image-20201028151324162" style="zoom:33%;" />

8. åœ¨æˆ‘ä»¬å®šä¹‰çš„protobufä¸­ï¼Œagency_idçš„ç±»å‹æ˜¯int32ï¼Œè€Œexternal_adè¡¨ä¸­çš„agency_idç±»å‹ä¸ºstringï¼Œä¸­é—´çš„ç±»å‹è½¬æ¢éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼šagencyId := strconv.Itoa(int(request.GetExternalAd().GetAgencyId()))

9. 

## Mysql Connection & Operation

1. è§£å†³Mysqlè¿æ¥çš„å›°æƒ‘
   1. è¿æ¥æ± æ˜¯ä¸€ç§èŠ‚çœé¢‘ç¹åˆ›å»ºé”€æ¯æ•°æ®åº“è¿æ¥çš„å¥½æ–¹æ³•ï¼ŒåŒæ—¶é€‚ç”¨äºå•çº¿ç¨‹å’Œå¤šçº¿ç¨‹çš„åœºæ™¯
   2. ä¸€ä¸ªäº‹åŠ¡éœ€è¦ä¸€ä¸ªconnectionï¼Œäº‹åŠ¡ä¸­æ‰€æœ‰çš„sqlè¯­å¥éƒ½åœ¨è¿™ä¸ªconnectionä¸­æ‰§è¡Œ
   3. äº‹åŠ¡çš„éš”ç¦»çº§åˆ«å¾ˆé‡è¦ï¼Œç”¨äºåº”ä»˜å¹¶å‘
   4. ä¸€æ¡å•ç‹¬çš„sqlè¯­å¥å…¶å®å°±ç›¸å½“äºä¸€ä¸ªäº‹åŠ¡ï¼Œå› æ­¤ä¸€æ¡å•ç‹¬çš„sqlè¯­å¥çš„æ‰§è¡Œéœ€è¦ä¸€ä¸ªconnection
   5. golangä¸­çš„çº¿ç¨‹æ± initï¼šsql.Openï¼Œdb.SetMaxIdleConnsï¼Œdb.SetMaxOpenConns
   6. golangä¸­åˆ›å»ºäº‹åŠ¡ï¼šdb.BeginTx
2. configæ–‡ä»¶çš„åŠ è½½
   1. ä½¿ç”¨urfave/cliåº“ï¼Œç¼–å†™å‘½ä»¤è¡Œç¨‹åº	
   2. å› ä¸ºæˆ‘ä»¬çš„æ•°æ®æ¥æºæ˜¯kafkaï¼Œæ‰€ä»¥ä¸ä¼šç”¨åˆ°httpå’Œgrpcçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä¸å¤ç”¨freewheelçš„servicekit.Serverä¸­çš„Initializableæ¥å£ï¼Œè‡ªå·±é‡æ–°ä»¿å†™ä¸€å¥—cliçš„å¤„ç†é€»è¾‘
   3. configè§£æï¼šå¤ç”¨freewheelçš„servicekit.Serverä¸­çš„Config
3. initDBï¼š
   1. åˆ›å»ºè¿æ¥æ± ï¼Œè®¾ç½®å„ç§å‚æ•°
   2. æµ‹è¯•è¿æ¥ï¼šlocalçš„mysql / dockeréƒ¨ç½²çš„mysql

## Dockeréƒ¨ç½²mysqlç¯å¢ƒï¼Œk8sç®¡ç†Dockerå®¹å™¨

1. docker-composeçš„æ–¹å¼ï¼Œå¯¹å‚æ•°çš„è¡¨ç¤ºæ›´åŠ ç›´è§‚
2. docker-composeä¸­çš„buildæŒ‡å®šDockerfileçš„è·¯å¾„ï¼Œåœ¨docker-compose upæ—¶ä¼šè‡ªåŠ¨å»æ‰¾åˆ°è¿™ä¸ªDockerfileåŠ è½½
3. dockeréƒ¨ç½²çš„mysqlï¼ŒiTermè¾“å…¥â€œdocker exec -it 43c777fc3ad08fd827dfadb451f5b3e7c59e4c9af8af9cb49f2816f3f1414dce /bin/sh; exitâ€è¿›å…¥mysqlå®¹å™¨ä¸­æµ‹è¯•
4. 

## GORMæ¡†æ¶

1. **gormtå·¥å…·**ï¼Œå°†mysqlè¡¨è½¬æ¢æˆgolangçš„struct

   1. ä¸‹è½½çš„æ—¶å€™ï¼Œç›´æ¥ä¸‹è½½å…¶binï¼Œæ›´æ”¹system preferenceä¹‹åå†è¿è¡Œ

   2. éœ€è¦é…ç½®å¥½sigularTableï¼ˆtrueè¡¨ç¤ºä¸ä½¿ç”¨å¤æ•°è¡¨åï¼‰ç­‰å„ç§è½¬æ¢è®¾ç½®

   3. åœ¨è½¬æ¢æˆstructæ—¶éœ€ä¸éœ€è¦å¤–é”®çš„å®Œæ•´å¯¹è±¡ï¼Œéœ€è¦è§†ä¸šåŠ¡éœ€æ±‚è€Œå®šï¼Œé…ç½®é¡¹ä¸º**is_foreign_key : false/true** (æˆ‘åœ¨é¡¹ç›®ä¸­æ²¡æœ‰å¯¼å‡ºå«å¤–é”®å¯¹è±¡çš„structï¼Œå› ä¸ºæ„Ÿè§‰å¤æ‚åº¦ä¼šå¢é«˜ä¸”æ²¡å¿…è¦ï¼‰

   4. sqlä¸­å…³äºå­—æ®µç±»å‹çš„å®šä¹‰ï¼Œè½¬æ¢æˆgolangä¸­çš„ç±»å‹æ—¶ï¼Œå¯èƒ½æœ‰ä¸€ç‚¹ç‚¹å½¢å¼ä¸Šçš„å·®å¼‚ï¼ˆå¦‚tinyint(1)ç±»å‹åœ¨golangä¸­ä¼šä½¿ç”¨boolç±»å‹ä»£æ›¿ï¼‰

   5. sqlä¸­å…³äºdefaultå€¼çš„å®šä¹‰ï¼Œè½¬æ¢æˆgolangä¸­çš„structæ—¶ï¼Œä¸ä¼šç›´æ¥è¡¨ç°åœ¨gorm tagä¸­ï¼Œ**éœ€è¦æ‰‹åŠ¨åŠ ä¸Š**ï¼Œè¿™æ ·åœ¨å‘mysqlå†™æ•°æ®çš„æ—¶å€™å³ä½¿not fill all fieldsä¹Ÿä¸ä¼šå‡ºé”™

      1. seatè¡¨ï¼š![image-20201112134305483](/Users/lugao/Library/Application Support/typora-user-images/image-20201112134305483.png)

      2. external_adè¡¨ï¼š![image-20201112151539272](/Users/lugao/Library/Application Support/typora-user-images/image-20201112151539272.png)

      3. campaignè¡¨ï¼š

         ![image-20201117114434985](/Users/lugao/Library/Application Support/typora-user-images/image-20201117114434985.png)

         ![image-20201117114455173](/Users/lugao/Library/Application Support/typora-user-images/image-20201117114455173.png)

      4. bannerè¡¨ï¼š

         ![image-20201117165542267](/Users/lugao/Library/Application Support/typora-user-images/image-20201117165542267.png)

         ![image-20201117165609673](/Users/lugao/Library/Application Support/typora-user-images/image-20201117165609673.png)

      5. External_ad_mappingè¡¨

         ![image-20201117171858021](/Users/lugao/Library/Application Support/typora-user-images/image-20201117171858021.png)
         
      6. Bidderè¡¨
      
         ![image-20201204135557078](/Users/lugao/Library/Application Support/typora-user-images/image-20201204135557078.png)
      
         ![image-20201204135625273](/Users/lugao/Library/Application Support/typora-user-images/image-20201204135625273.png)
      
         

2. gormçš„**autoMigrate**ï¼Œå°†golangçš„structç›´æ¥è½¬æ¢æˆmysqlè¡¨(æ¯”è¾ƒé€‚åˆè¡¨å°‘çš„æƒ…å†µ)

3. éœ€è¦ä½¿ç”¨**gorm.Open()**æ¥åˆ›å»ºMySQLè¿æ¥ï¼Œ**db.LogDebug()**å±•ç¤ºgormä½¿ç”¨ä¸­çš„sqlè¯­å¥åŠä»£ç è¿è¡Œä¿¡æ¯

4. gorm***å°†æ²¡æ‰¾åˆ°æ•°æ®ä¹Ÿå®šä¹‰ä¸ºErrorè¿”å›***ï¼ˆä½†è¿™å…¶å®å¹¶ä¸æ˜¯ç¨‹åºè¿è¡Œä¸Šçš„é”™è¯¯ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªå‘ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸šåŠ¡å±‚é¢å†æ¥è¿›ä¸€æ­¥åŒºåˆ†æ˜¯ä¸šåŠ¡errorè¿˜æ˜¯ç¨‹åºerror

5. db.First()æ ¹æ®ä¸»é”®æ¥æŸ¥è¯¢è®°å½•æ—¶ï¼Œåªæ”¯æŒ***ä¸»é”®ç±»å‹ä¸ºæ•´å‹***

   ```go
   // ä½¿ç”¨ä¸»é”®è·å–è®°å½•
   db.First(&user, 10)
   //// SELECT * FROM users WHERE id = 10;
   ```

6. **æ’å…¥å«æœ‰å¤–é”®çº¦æŸçš„è®°å½•**æ—¶ï¼Œä¸éœ€è¦å…ˆåˆ›å»ºå¤–é”®å¯¹è±¡

7. é€šè¿‡structæ¥æŸ¥è¯¢æ—¶ï¼Œ***æ— æ³•æŸ¥è¯¢åˆ°éé›¶å­—æ®µ***

   <img src="/Users/lugao/Library/Application Support/typora-user-images/image-20201112140317569.png" alt="image-20201112140317569" style="zoom:33%;" />

8. **db.RowsAffected**å­—æ®µï¼Œä»£è¡¨ç€è¢«update/insert/deleteæ‰€å½±å“çš„è¡Œæ•°ï¼Œç†è®ºä¸Šæ¥è¯´1æ˜¯æ­£å¸¸çš„ï¼ˆå¤§äº1è¯´æ˜æ“ä½œä¼šå½±å“åˆ°å…¶ä»–è¡Œï¼Œç­‰äº0è¯´æ˜æ“ä½œå¤±è´¥ï¼‰

9. 

## Golangæ¥å£/æŒ‡é’ˆç­‰è¯­æ³•

1. æ¥å£ï¼šåªè¦æŸä¸ªstructå®ç°äº†ä¸€ä¸ªinterfaceçš„æ‰€æœ‰æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªstuctå°±implementäº†è¿™ä¸ªinterface

2. golangä¸­çš„è°ƒç”¨æ˜¯é€šè¿‡packageæ¥æ‰¾çš„ï¼Œä¸€ä¸ªpackageä¸‹ä¸èƒ½æœ‰åŒåçš„åŒç±»å‹å£°æ˜

3. golangä¸­çš„å¾ªç¯è°ƒç”¨errorï¼Œå¯ä»¥é€šè¿‡interfaceçš„æ–¹å¼æ¥é¿å…ï¼ˆå¦‚æˆ‘ä»¬é¡¹ç›®ä¸­çš„InitializerInterfaceè¿™ä¸ªinterfaceå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼‰

4. ä»¥jsonæ ¼å¼æ¥æ‰“å°ç»“æ„ä½“

   ```go
   bytes, _ := json.Marshal(bidder)
   fmt.Println(string(bytes))
   ```

5. golangä¸­çš„é”™è¯¯å’Œå¼‚å¸¸å¤„ç†ï¼šhttps://www.jianshu.com/p/f30da01eea97

6. golangä¸­çš„**int æ˜¯**å¸¦ç¬¦å·æ•´æ•°**ç±»å‹**ï¼Œå…¶å¤§å°è‡³å°‘ä¸º32**ä½**ã€‚ å®ƒ**æ˜¯**ä¸€ç§ç¡®åˆ‡çš„**ç±»å‹**ï¼Œè€Œä¸æ˜¯int32 çš„åˆ«åã€‚

7. golangçš„å…¬æœ‰interfaceå’Œç§æœ‰structå¯ä»¥ä¸€èµ·å®ç°å¤šæ€ï¼ˆå¦‚æˆ‘ä»¬é¡¹ç›®ä¸­çš„handlerå’Œdaoå±‚çš„è®¾ç½®ï¼‰

8. golangçš„structä¸­åµŒå¥—structå¯ä»¥å®ç°ç»§æ‰¿ï¼ˆä½†æ˜¯ä¸€èˆ¬æ¥è¯´ï¼Œæ¨èä½¿ç”¨compositionè€Œä¸æ˜¯inheritanceï¼‰

9. golangä¸æ”¯æŒåŒåæ–¹æ³•çš„é‡è½½

10. deferå…³é”®å­—ï¼Œå¯ä»¥ç”¨äºåœ¨å‡½æ•°returnä¹‹å‰æ‰§è¡Œä¸€äº›å›ºå®šçš„æ”¶å°¾å·¥ä½œï¼ˆæ³¨æ„âš ï¸ï¼šreturnè¯­å¥ä¸æ˜¯ä¸€ä¸ªåŸå­è¯­å¥ï¼Œdeferå†…å®¹ä¼šåœ¨returnè¯­å¥èµ‹å€¼ä¹‹åè¿”å›ä¹‹å‰æ‰§è¡Œï¼Œè¦ç‰¹åˆ«æ³¨æ„ä¸è¦å¼„é”™å’¯ï¼‰

11. sliceå’Œarrayçš„å®šä¹‰è¦æ³¨æ„åŒºåˆ«

12. mapçš„éå†ï¼Œä½¿ç”¨map[e]çš„æ–¹å¼(return e.val, existence)ã€‚å³ä½¿eä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œä¼šè¿”å›è¯¥ç±»å‹çš„åˆå§‹å€¼ä»¥åŠfalse



## ä»£ç ç»“æ„è®¾è®¡

1. gorm.DBè¿™ä¸ªå¯¹è±¡æ˜¯å…¨å±€çš„ï¼Œå› æ­¤ç”¨åˆ°å®ƒçš„seatDaoå’ŒexternalAdDaoæœ€å¥½ä¹Ÿè®¾ç½®ä¸ºæ¯ä¸ªçº¿ç¨‹ä¸­å”¯ä¸€æ‹¥æœ‰ï¼Œé‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼ˆé€šè¿‡interfaceã€ç§æœ‰structå’Œå…¬æœ‰Getæ–¹æ³•å®ç°ï¼‰
2. éœ€è¦è¢«å¤šä¸ªpackageä½¿ç”¨åˆ°çš„å¯¹è±¡ï¼Œæ˜¯é€šè¿‡é¢å‘å¯¹è±¡çš„æ–¹å¼ä¼ é€’ï¼Œè¿˜æ˜¯é€šè¿‡å‡½æ•°è°ƒç”¨æ¥è¿›è¡Œå‚æ•°ä¼ é€’å‘¢ï¼Ÿï¼ˆä½¿ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼å§ï¼‰
3. errorè¦é€å±‚åœ°æ¥åŒ…è£…å’Œæ•è·ï¼Œä¸å¿…è¦è¿”å›errorçš„åœ°æ–¹å°±ä¸è¦è¿”å›
4. 

## ä½¿ç”¨Makefileè„šæœ¬å·¥å…·



## Deduplicateè®¾è®¡ä¸å®ç°

1. ä½¿ç”¨globalå¸¦time windowçš„ä¸€ä¸ªç¼“å­˜ç»“æ„(å¦‚LRU Cache)ï¼Œå­˜å‚¨10minï¼ˆDE load mysqlçš„æ—¶é—´é—´éš”ï¼‰å†…æ‰€æœ‰çº¿ç¨‹çš„processorå¤„ç†è¿‡çš„seatå’Œexternal_ad
2. LRU Cacheï¼ˆ**Least Recently Used**ï¼‰çš„å®ç°
   1. äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šgormé»˜è®¤æ˜¯ä½¿ç”¨æ•°æ®åº“çš„ï¼Œå¦‚mysqlä¸ºâ€œå¯é‡å¤è¯»â€ï¼ˆgormåˆ›å»ºäº‹åŠ¡æ—¶ä¸èƒ½æ‰‹åŠ¨è®¾ç½®éš”ç¦»çº§åˆ«ï¼‰
   2. golangçš„syncåŒ…ï¼Œæä¾›lockï¼ˆäº’æ–¥é”ã€è¯»å†™é”ï¼‰ã€poolå’ŒwaitGroupç­‰
   3. ç¼“å­˜ç»“æ„ï¼šæ‹Ÿé‡‡ç”¨mapï¼ˆkeyä¸ºseatIdæˆ–è€…externalAdIdï¼Œvalueä¸ºexpiredTimeï¼‰
   4. è¶…æ—¶åˆ é™¤ï¼šä¸»è¦æœ‰ä¸»åŠ¨åˆ é™¤/è¢«åŠ¨åˆ é™¤ä¸¤ç§æ–¹å¼ï¼ˆä¸»åŠ¨åˆ é™¤éœ€è¦ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè€—CPUï¼›è¢«åŠ¨åˆ é™¤ä¸èƒ½åŠæ—¶åˆ é™¤è¿‡æœŸkeyï¼Œè€—å†…å­˜ï¼‰ï¼Œæ‹Ÿé‡‡ç”¨ä¸»åŠ¨åˆ é™¤
   5. é”ï¼šæ‹Ÿé‡‡ç”¨sync.RWMutex
   6. å°†ttlåŠ åˆ°configé…ç½®ä¸­
   7. åˆ›å»ºä¸€ä¸ªdaemon goroutineï¼Œè‡ªåŠ¨æ£€æŸ¥è¿‡æœŸçš„å…ƒç´ å¹¶åˆ é™¤ï¼ˆä½¿ç”¨time.Tickeré—´éš”å®šæ—¶å™¨ï¼Œå†…éƒ¨åŒ…å«ä¸€ä¸ªCé€šé“æ¥å®šæœŸä¼ è¾“æ—¶é—´ï¼Œæ­é…select caseä½¿ç”¨ï¼‰
   8. **å¯å‘**ï¼šä½¿ç”¨ç»„åˆçš„æ–¹å¼åˆ›å»ºä¸€ä¸ªæ–°çš„structæ¥å®Œæˆä¸€äº›å­˜å‚¨å’Œæ“ä½œï¼Œå¯¹äºä¸€äº›å®ˆæŠ¤åå°è¿›ç¨‹å¯ä»¥ç”¨runtime.SetFinalizeræ¥ä¼˜é›…çš„æ‰§è¡Œå…³é—­
3. å¯¹seatå’Œexternal_adåˆ†åˆ«è®¾ç½®ä¸€ä¸ªflagï¼Œæ£€æŸ¥seatå’Œexternal_adæ˜¯å¦å·²è¢«å¤„ç†è¿‡ï¼ŒæŒ‰ç…§flagæ¥èµ°åé¢çš„å¤„ç†æµç¨‹
4. åœ¨è¿›è¡Œsqlæ“ä½œæ—¶ï¼Œä¹Ÿä¼šå…ˆåˆ¤æ–­ä¸€ä¸‹seatå’Œexternal_adæ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå­˜åœ¨çš„è¯å°±ä¸å¤„ç†äº†

## Kafka ç”Ÿäº§&æ¶ˆè´¹

1. kafkaç”Ÿäº§è€…ï¼ŒæŒ‰ç…§ä»€ä¹ˆkeyæ¥åˆ†å‘messageåˆ°partition ï¼ˆå¯¹åç»­dedupç›®å‰æ²¡å½±å“ï¼Œç›®å‰é‡‡ç”¨externalAdIdå’ŒseatIdçš„å“ˆå¸Œï¼‰

2. æ ¹æ®ä¼°è®¡ï¼Œexternal_adè¡¨æ¯å°æ—¶æ’å…¥2000-7000è¡Œè®°å½•ä¸ç­‰ï¼Œå¹³å‡æ¯è¡Œè®°å½•å¤§å°ä¸º2kbï¼Œæ¯å°æ—¶kafkaçš„è´Ÿè½½ä»…ä¸ºMBçº§åˆ«ï¼›campaignsã€bannersç­‰è¡¨æ•°æ®é‡æ›´å°ï¼Œæ— å‹åŠ›ï¼Œå¯å¿½ç•¥

3. ä½¿ç”¨saramaå’Œsarama-clientæ¡†æ¶ï¼Œéœ€è¦åœ¨go/srcç›®å½•ä¸‹æ‰§è¡Œgovendor fetch github.com/Shopify/saramaæ¥æ›´æ–°è¿™ä¸ªåŒ…ï¼ŒåŸæ¥çš„åŒ…ä¸æ”¯æŒconsumer-groupï¼ˆæœ‰ä¸€äº›ä¾èµ–å¦‚gokrb5ç­‰çš„ä¸‹è½½é‡åˆ°äº†å¾ˆå¤šç¹ççš„é—®é¢˜ï¼Œéœ€è¦ä¸€ä¸ªä¸ªæ‰‹åŠ¨æ¥ä¸‹è½½ï¼Œè´¼éº»çƒ¦â€¦â€¦ä¸è¿‡æŒºä½å§ï¼‰

4. **saramaä¸­çš„consumeræ¨¡å¼ï¼š**

   æ•´ç†ä¸€ä¸‹ partitionConsumer ä¸ brokerConsumer ä¹‹é—´çš„äº¤äº’è¿˜æ˜¯æœ‰ç‚¹å¤æ‚çš„ï¼Œå¤§æ¦‚æ˜¯ï¼š

   1. partitionConsumer é€šè¿‡ broker.input è¿™ä¸ª chan åŠ å…¥ brokerConsumer çš„è®¢é˜…ï¼›
   2. åŠ å…¥è®¢é˜…åï¼ŒbrokerConsumer æ¯æ¬¡ fetchNewMessages å¾—åˆ°ä¸€æ‰¹æ¶ˆæ¯ï¼Œä¼šå‘ç»™æ¯ä¸ª partitionConsumer çš„ feeder chanï¼›
   3. æ¯ä¸ª partitionConsumer è§£æ feeder chan çš„æ•°æ®å¾—åˆ° å¯¹åº”çš„æ¶ˆæ¯åˆ—è¡¨ï¼ŒåŒæ—¶è®¾ç½®è‡ªèº«çš„ responseResultï¼Œè®¾ç½® brokers.acks è¿™ä¸ª WaitGoup æ‰§è¡Œ Done()ï¼Œè¡¨ç¤ºå¤„ç†å®Œæ¯•è¯¥æ‰¹æ¬¡ï¼›
   4. brokerConsumer ç­‰å¾…æ¯ä¸ª partitonConsumer å¤„ç†å®Œæ¯•è¯¥æ‰¹æ¬¡ï¼Œå¤„ç†æ‰€æœ‰ partitionConsumer çš„ responseResult åå¾ªç¯ fetchNewMessagesï¼›

5. consumerçš„ç»ˆæ­¢ï¼š

   1. ä½¿ç”¨waitgroupæ¥æ§åˆ¶å¤šä¸ªpartitionConsumeréƒ½æ¶ˆè´¹å®Œæ¶ˆæ¯
   2. ä½¿ç”¨os.Signalçš„channelæ¥æ§åˆ¶consumerçš„ç»ˆæ­¢ï¼ˆæ³¨æ„âš ï¸ï¼šæ¯ä¸ªgoroutimeå†…éƒ¨éƒ½éœ€è¦æ³¨å†Œä¸€ä¸ªsignalçš„Notifierï¼Œæ‰èƒ½ä¿è¯è¿™äº›goroutineéƒ½èƒ½è¢«ç»ˆæ­¢ã€‚å¦‚æœå…±äº«signalç›‘å¬çš„è¯ï¼Œæœ‰å¤šå°‘ä¸ªgoroutineå°±éœ€è¦å¤šå°‘ä¸ªsignalæ¥è¿›è¡Œä¸€ä¸€ç»ˆæ­¢ï¼‰
   3. 

6. consumerçš„offsetæ‰‹åŠ¨æäº¤:

   1. brokerConsumer ä¼šè´Ÿè´£å‘èµ· FetchRequest çš„ä¸»å¾ªç¯ï¼Œæ¯è½®è¿­ä»£æ‹‰å–ä¸€æ‰¹æ¶ˆæ¯ï¼Œå‘é€ç»™æ¯ä¸ª partitionConsumer å†è½¬ç»™ç”¨æˆ·çš„ messages chanã€‚é€šè¿‡ acks è¿™ä¸ª WaitGroup æ¥åè°ƒæ¯ä¸ª partitionConsumer å¯¹è¿™ä¸€æ‰¹æ¬¡çš„æ¶ˆæ¯çš„å¤„ç†èŠ‚å¥ã€‚
   2. éé˜»å¡channelï¼šä½¿ç”¨goroutineï¼Œè®©channelè¯»å’Œå†™ä¸åœ¨ä¸€ä¸ªçº¿ç¨‹å†…å°±ok
   3. ï¼ˆ**ç›®å‰å‘ç°saramaå¥½åƒä¸æ”¯æŒæ‰‹åŠ¨æäº¤**ğŸ˜·ï¼Œæ‰€ä»¥å°±æ‰‹åŠ¨æ”¶é›†å¤„ç†å¤±è´¥çš„messageï¼Œæ”¾å…¥ä¸€ä¸ªchannelä¸­ï¼Œä¾›é”™è¯¯æ’æŸ¥å’Œé‡æ–°å¤„ç†ï¼‰

## å®šæ—¶å¤„ç†æ–°çš„to-completeä¸º0çš„seatï¼Œä¸ºå…¶åˆ›å»ºç›¸åº”çš„records

1. https://cloud.tencent.com/developer/article/1422445 golangä¸­cronå®šæ—¶ä»»åŠ¡çš„ä½¿ç”¨æ•™ç¨‹
2. åœ¨ä¸ºæ–°completeçš„seatåˆ›å»ºå¯¹åº”çš„bidderæ—¶ï¼Œéœ€è¦ghost bidderçš„ä¿¡æ¯ï¼Œè¿™é‡Œæ€ä¹ˆè§£å†³ï¼Ÿï¼ˆä½¿ç”¨ç£ç›˜å­˜å‚¨çš„æ–¹å¼æ¥å­˜ä¸‹æˆ‘ä»¬æ­¤å‰å¤„ç†è¿‡çš„unknown seatå’Œå¯¹åº”generic bidderï¼›å®šæ—¶æŸ¥è¯¥ç£ç›˜æ–‡ä»¶ï¼Œå¯¹æ–°completeçš„seatåˆ›å»ºbidder/campaign/bannerè¿™äº›ä¿¡æ¯ï¼Œåˆ›å»ºå®Œæˆååˆ é™¤è¿™æ¡è®°å½•ï¼‰
3. golangæŒä¹…åŒ–æŠ€æœ¯ï¼Œè¿½åŠ å­˜å‚¨ï¼ˆcsvæ–‡ä»¶ï¼‰
4. ä¸šåŠ¡çŸ¥è¯†ï¼š**seatè¡¨ä¸­çš„seatIdå’Œbuyer_platform_idä¸€èµ·å”¯ä¸€è¡¨ç¤ºä¸€ä¸ªseatï¼Œè€Œbidderè¡¨ä¸­çš„agency_idä¸external_idï¼ˆå³å¯¹åº”seat_idï¼‰å’Œbuyer_platform_idä¸€èµ·å”¯ä¸€è¡¨ç¤ºä¸€ä¸ªbidder**
5. 

## Kafka Send ERRORï¼šdial tcp 172.20.0.4:9092: i/o timeout 

è¿™æ˜¯ä¸€ç§kafkaå’Œä¸»æœºç¨‹åºå¤„äºä¸åŒç½‘ç»œç¯å¢ƒä¸‹ä¼šå‘ç”Ÿçš„é—®é¢˜ï¼ï¼ˆæ¯”å¦‚ï¼Œdockerå†…çš„kafkaå®¹å™¨ & localhostçš„clientç¨‹åºï¼‰

è¯´æ˜ï¼š

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨producer/consumerè¿™äº›clientä¸­ä¸ºkafkaé…ç½®**ä»£ç†ip**ï¼Œä»¥ä¾¿clientèƒ½æ‰¾åˆ°ç›¸åº”çš„kafkaæœåŠ¡ã€‚å¯æ˜¯è¿™é‡Œçš„ä»£ç†ipåªæ˜¯è®©clientä¸kafkaå»ºç«‹**initial connection**ï¼Œä¹‹åkafkaä¼šåœ¨è¿™æ¬¡connectionä¸­è¿”å›å…³äºpartitionçš„leader brokerçš„metadataï¼ˆåŒ…æ‹¬brokerçš„**å®é™…ip**ï¼‰ã€‚è€Œåclientåœ¨å®é™…produceæˆ–è€…consumeæ—¶ï¼Œæ‰ä¼šå†å°è¯•å»è¿æ¥ç›¸åº”topicçš„metadataä¸­çš„brokerå®é™…ipã€‚æ‰€ä»¥ï¼Œå½“å®é™…broker ipä¸client ipåœ¨åŒä¸€å±€åŸŸç½‘ä¸‹èƒ½ç›´è¿çš„æ—¶å€™ï¼Œä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ï¼Œä»¥ä¸Šç»†èŠ‚å¯¹ç”¨æˆ·æ˜¯é€æ˜çš„ï¼›ä½†æ˜¯ä¸¤è€…è‹¥ä¸åœ¨åŒä¸€å±€åŸŸç½‘ä¸‹ï¼Œå°±æ— æ³•pingé€šï¼Œç”Ÿäº§æˆ–è€…æ¶ˆè´¹å°±ä¼šå¤±è´¥ã€‚

è§£å†³ï¼š

æ€è·¯æ˜¯â€œæŠŠmetadateè¿”å›çš„å®é™…ipç»è¿‡ä¸€å±‚è½¬ä¹‰ï¼Œæš´éœ²ç»™clientå¯ä»¥ç›´è¿çš„å±€åŸŸç½‘ipâ€ï¼Œæ›´æ”¹kafkaçš„listenerç›¸å…³é…ç½®ã€‚å…¶ä¸­ï¼Œlistenerå®šä¹‰çš„æ˜¯kafkaæœåŠ¡ç›‘å¬çš„ipå’Œportï¼Œadvertised_listenerå®šä¹‰çš„åˆ™æ˜¯å¯¹åº”listeneråˆ†åˆ«å¯¹å¤–ç›‘å¬å’Œå¯¹å¤–è¿”å›çš„ipå’Œportï¼Œkafka_inter_broker_listener_nameå®šä¹‰çš„æ˜¯kafkaæœåŠ¡å†…éƒ¨çš„ç›‘å¬é…ç½®åã€‚

ä¸¾ä¾‹ï¼š

å½“kafka:9092æ”¶åˆ°è¿æ¥è¯·æ±‚ï¼Œå°†ä¼šæ˜ å°„åˆ°kafka:9092ä¸Šè¿›è¡ŒæœåŠ¡ï¼Œä¸”è¿”å›çš„broker metadataä¸ºkafka:9092ï¼›å½“localhost:9094æ”¶åˆ°è¿æ¥è¯·æ±‚ï¼Œå°†ä¼šæ˜ å°„åˆ°kafka:9094ä¸Šè¿›è¡ŒæœåŠ¡ï¼Œä¸”è¿”å›çš„broker metadataä¸ºlocalhost:9094ã€‚

è€Œkafka_inter_broker_listener_nameä¸ºINTERNALï¼Œè¡¨ç¤ºçš„æ˜¯ï¼šINTERNALå®šä¹‰çš„è¿™ä¸€ç»„äº’ä¸ºæ˜ å°„çš„listeneræ˜¯kafkaåœ¨å±€åŸŸç½‘å†…éƒ¨ä½¿ç”¨çš„é…ç½®ï¼ˆæ¯”å¦‚åœ¨å¯åŠ¨KafkaæœåŠ¡ï¼Œåˆ›å»ºpartitioné…ç½®leadçš„æ—¶å€™ï¼‰ã€‚

<img src="/Users/lugao/Library/Application Support/typora-user-images/image-20201127111807026.png" alt="image-20201127111807026" style="zoom:50%;" />

å‚è€ƒï¼šhttps://www.confluent.io/blog/kafka-listeners-explained/



## Unit Test

1. handlerã€cacheã€processorï¼šæµ‹è¯•æµç¨‹é€»è¾‘æ­£ç¡®æ€§ï¼Œéœ€è¦ç”¨åˆ°mockå’Œassertï¼ˆäº‹åŠ¡å•æµ‹æ—¶è¿˜éœ€è¦ç”¨åˆ°sqlmockï¼Œæ¨¡æ‹Ÿä¸€ä¸ªdbäº‹åŠ¡çš„beginã€commitå’Œrollbackï¼‰ã€è¿™å„¿æœ‰ä¸ªnilçš„å‘ï¼Œæ²¡æœ‰æ­£é¢è§£å†³ï¼Œä½¿ç”¨åˆ›å»ºå•æµ‹ä¸“ç”¨å˜é‡çš„æ–¹å¼è§„é¿äº†ã€‘

2. daoï¼šæµ‹è¯•æ•°æ®åº“æ“ä½œæ­£ç¡®æ€§ï¼Œéœ€è¦å¯åŠ¨ä¸€ä¸ªtemporary mysqlæ¥assertéªŒè¯ï¼ˆsqlmockï¼‰

3. ä¸€ä¸ªshadowed err returnçš„é—®é¢˜ï¼šåœ¨äº‹åŠ¡æ“ä½œæ—¶ï¼Œç»å¸¸ä¼šç”¨åˆ°deferï¼Œä½†æ˜¯deferçš„erræœ‰æ—¶å€™ä¼šæ˜¯shadowed errorï¼Œå¾ˆå®¹æ˜“å‡ºç°æ··ä¹±ï¼ˆshadowed errorï¼šä¸Šå±‚çš„åŒåerrorã€‚ï¼‰

   **whereï¼Ÿ**

   ã€€ã€€Goç¨‹åºå‡½æ•°ä¸­åœ¨é€šè¿‡ returnå…³é”®å­—è¿”å›çš„æ—¶å€™ï¼ŒæŠ¥é”™

   **why?**

   ã€€ã€€å˜é‡ä½œç”¨åŸŸçš„é—®é¢˜ï¼Œåœ¨å­ä½œç”¨åŸŸå®šä¹‰ä¸€ä¸ªä¸Šå±‚ä½œç”¨åŸŸçš„åŒåçš„å˜é‡

   ![image-20201225163230034](/Users/lugao/Library/Application Support/typora-user-images/image-20201225163230034.png)

## import cycle bug

åŸå› ï¼šAä¾èµ–Bï¼ŒBä¾èµ–Aï¼Œé€ æˆå¾ªç¯ä¾èµ–

è§£å†³ï¼šå¯ä»¥ç”¨interfaceæ¥è§£å†³

## no vendored package was allowed

åŸå› ï¼šæœ‰å¤šä¸ªvendorä¸‹éƒ½æœ‰ç›¸åŒçš„åŒ…ï¼Œç¼–è¯‘æ—¶ä¸çŸ¥é“è¯¥ä½¿ç”¨å“ªä¸ªä¾èµ–åŒ…

è§£å†³ï¼šè§£å†³åŒ…å†²çªï¼ŒæŸ¥çœ‹goç‰ˆæœ¬çš„SDKä¸­çš„ä¾èµ–

## sql: unknown driver "mysql" (forgotten import?)

åŸå› ï¼šæœªå¯¼å…¥mysqlé©±åŠ¨çš„ä¾èµ–åŒ…

è§£å†³ï¼šimport _ "github.com/go-sql-driver/mysql"ï¼ˆ â€œ_â€ä¸‹åˆ’çº¿è¡¨ç¤ºè¿™ä¸ªåŒ…åœ¨ä»£ç ä¸­ä¸ä¼šæ˜¾å¼åœ°è¢«è°ƒç”¨ï¼Œå°†ä½œä¸ºå‰¯ä½œç”¨ä½¿ç”¨ï¼‰

## mysqlç«¯å£å†²çªé—®é¢˜

docker-composeä¸­çš„portç¯å¢ƒå˜é‡ï¼šâ€œç°portï¼šé»˜è®¤portâ€

åŸå› ï¼šæœ¬åœ°çš„mysqlå’Œdockerå¯åŠ¨çš„mysqlï¼Œéƒ½ä½¿ç”¨3306ç«¯å£ï¼Œé€ æˆgolang projectè¿æ¥127.0.0.1:3306æ—¶é€‰æ‹©mysqlå‡ºé—®é¢˜

è§£å†³ï¼šåœæ‰æˆ–æ›´æ”¹æœ¬åœ°mysqlçš„ç«¯å£å· / æ›´æ”¹dockerä¸­mysqlçš„ç«¯å£å·

## mysql datetimeä¸golang time.Timeå½¢å¼ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆä½¿ç”¨gormï¼‰

é—®é¢˜ï¼š

mysqlä¸­çš„datetimeå’Œdateç±»å‹ï¼Œmarshalåå±•ç¤ºæ ¼å¼ä¸ºâ€œ2020-11-16 10:10:10â€ï¼›

è€Œgolangä¸­çš„time.Timeç±»å‹ï¼Œmarshalåçš„å±•ç¤ºæ ¼å¼ä¸ºâ€œ2020-11-16 10:10:10 +0000 UTC â€ï¼›

ä¸¤è€…æ ¼å¼çš„ä¸ä¸€æ ·ï¼Œä½¿å¾—ç”¨golangè¯»å†™mysqlæ—¶æ¶‰åŠåˆ°è®¸å¤šæ ¼å¼ä¸Šçš„é—®é¢˜

å‚è€ƒï¼šhttps://l1905.github.io/golang/mysql/2020/07/14/golang-user-mysql-datetime/

è§£å†³æ–¹æ¡ˆï¼š

æ–¹æ¡ˆ1: åœ¨è¿æ¥mysqlæ—¶ï¼Œå°†å‚æ•°parseTimeè®¾ä¸ºfalseï¼Œè¡¨ç¤ºâ€œè¯»å†™mysqlæ—¶ä¸ä¼šå°†mysqlçš„datetime/dateç±»å‹è‡ªåŠ¨è½¬æ¢æˆgolangçš„time.Timeç±»å‹ï¼Œè€Œå°†ç›´æ¥è½¬æ¢æˆæ–‡æœ¬å­—ç¬¦ä¸²stringç±»å‹â€ï¼Œè¿™æ ·çš„è¯ä¸¤è€…åœ¨å±•ç¤ºæ ¼å¼ä¸Šå°†ä¿æŒä¸€è‡´äº†ã€‚ï¼ˆç¼ºé™·ï¼šåœ¨å¤§éƒ¨åˆ†ç¨‹åºä¸­ï¼Œ æˆ‘ä»¬è¿˜æ˜¯éœ€è¦å°†æ—¶é—´ç±»å‹è®¾ç½®ä¸ºtime.Timeï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œæ—¶é—´åˆ°å­—ç¬¦ä¸²ï¼Œæ—¶é—´æ¯”è¾ƒç­‰ä¸€äº›æ“ä½œã€‚æ‰€ä»¥è¿™ç§æ–¹å¼è¿‡äºæ­»æ¿ï¼Œä¸å¤Ÿçµæ´»ï¼‰

æ–¹æ¡ˆ2: parseTimeä¾æ—§è®¾ä¸ºtrueï¼Œè¯»å†™mysqlæ—¶golangçš„time.Timeç±»å‹èƒ½ä¸mysqlçš„datetime/dateç±»å‹è‡ªåŠ¨è½¬æ¢ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªtime.Timeçš„åˆ«åï¼ˆå¦‚MyTimeç±»å‹ï¼‰æ¥æ‰§è¡Œç‹¬ç‰¹çš„marshalå‡½æ•°ï¼Œä½¿å¾—åœ¨å±•ç¤ºMyTimeç±»å‹çš„æ—¶å€™èƒ½å¾—åˆ°å’Œmysqlä¸­çš„datetime/dateä¸€æ ·çš„æ ¼å¼ã€‚

## mysqlé”™è¯¯â€œIncorrect datetime value: '0000-00-00 00:00:00'â€

åŸå› ï¼šMySQL5.7ä»¥åï¼Œé»˜è®¤ä½¿ç”¨NO_ZERO_DATEæ¨¡å¼ï¼Œæ‰€ä»¥'0000-00-00 00:00:00'è¿™ç§datetimeè¢«è®¤ä¸ºæ˜¯æ— æ•ˆçš„

è§£å†³ï¼š

æ–¹æ¡ˆ1: æ”¹è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œé¿å…å‡ºç°'0000-00-00 00:00:00'å€¼

æ–¹æ¡ˆ2: æ”¹MySQLé…ç½®

## Mid-term Discussion

ç›®å½•ç»“æ„ã€Œmain.goã€vendorã€protoã€configã€appã€

ä¸šåŠ¡æµç¨‹ã€Œå‘½ä»¤è¡Œå¯åŠ¨ï¼Œåˆå§‹åŒ–ï¼Œæ¨¡æ‹Ÿä»Kafkaå–æ•°æ®å¤„ç†å’Œcommitï¼Œååºåˆ—åŒ–protobufï¼Œåˆ›å»ºhandlerå’Œdaoï¼Œä¸šåŠ¡é€»è¾‘æ¢³ç†ï¼Œprocessor/handler/daoå±‚åˆ†å·¥ï¼Œgormæ¡†æ¶è¯»å†™mysqlï¼Œerroræ•è·æ˜¯é€å±‚çš„ã€

åç»­å®‰æ’ã€Œæµé‡ä¼°è®¡ï¼Œçœ‹kafkaç›¸å…³çš„ä¸œè¥¿ï¼ŒUTã€

